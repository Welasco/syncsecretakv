<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>SyncSecretAKV Kubernetes Controller</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="SyncSecretAKV Kubernetes Controller" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://0.0.0.0:4000/" />
<meta property="og:url" content="http://0.0.0.0:4000/" />
<meta property="og:site_name" content="SyncSecretAKV Kubernetes Controller" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="SyncSecretAKV Kubernetes Controller" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","headline":"SyncSecretAKV Kubernetes Controller","name":"SyncSecretAKV Kubernetes Controller","url":"http://0.0.0.0:4000/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d07cd1127dd347eb55d712b19cba884d80c62590">
    <script src="https://code.jquery.com/jquery-3.3.0.min.js" integrity="sha256-RTQy8VOmNlT6b2PIRur37p6JEBZUE7o8wPgMvu18MC4=" crossorigin="anonymous"></script>
    <script src="/assets/js/main.js"></script>
    <!--[if lt IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>

      <header>
        <h1>SyncSecretAKV Kubernetes Controller</h1>
        <p></p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/Welasco/syncsecretakv" class="button fork"><strong>View On GitHub</strong></a>
        
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1 id="syncsecretakv-kubernetes-controller">SyncSecretAKV Kubernetes Controller</h1>

<h2 id="syncsecretakv-kubernetes-controller-for-synchronizing-tls-secrets-to-azure-key-vault">SyncSecretAKV Kubernetes Controller for Synchronizing TLS Secrets to Azure Key Vault</h2>

<p>This Kubernetes Controller is designed to synchronize TLS Secrets created by Cert-Manager to Azure Key Vault. Cert-Manager is another Kubernetes controller that issues certificates from Let’s Encrypt. The primary purpose of this controller is to enable the reuse of Let’s Encrypt TLS certificates across various Azure resources, such as Azure Application Gateway and Azure VMs.</p>

<h2 id="features">Features</h2>

<ul>
  <li><strong>Automated Synchronization</strong>: Seamlessly syncs TLS Secrets from Kubernetes to Azure Key Vault.</li>
  <li><strong>Cert-Manager Integration</strong>: Works in conjunction with Cert-Manager to manage certificate issuance and renewal.</li>
  <li><strong>Azure Resource Compatibility</strong>: Allows Let’s Encrypt TLS certificates to be utilized by any Azure resource that supports Azure Key Vault.</li>
</ul>

<h2 id="use-cases">Use Cases</h2>

<ul>
  <li><strong>Azure Application Gateway</strong>: Secure your web applications with Let’s Encrypt certificates stored in Azure Key Vault.</li>
  <li><strong>Azure VMs</strong>: Easily manage and deploy TLS certificates to your virtual machines.</li>
</ul>

<h2 id="getting-started">Getting Started</h2>

<ol>
  <li><a href="#1-install-cert-manager"><strong>Install Cert-Manager</strong></a>: Ensure Cert-Manager is installed and configured in your Kubernetes cluster.</li>
  <li><a href="#2-configure-azure-key-vault"><strong>Configure Azure Key Vault</strong></a>: Set up your Azure Key Vault and configure the necessary permissions.</li>
  <li><a href="#3-deploy-the-controller"><strong>Deploy the Controller</strong></a>: Deploy this Kubernetes Controller to your cluster.</li>
  <li><a href="#4-configuring-syncsecretakv-controller"><strong>Configuring SyncSecretAKV controller</strong></a>: The controller will automatically synchronize TLS Secrets from Cert-Manager to Azure Key Vault.</li>
</ol>

<h2 id="1-install-cert-manager">1. <strong>Install Cert-Manager</strong></h2>

<p>Ensure Cert-Manager is installed and configured in your Kubernetes cluster. You can use the following commands to install Cert-Manager:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add jetstack https://charts.jetstack.io <span class="nt">--force-update</span>
helm repo update
helm <span class="nb">install</span> <span class="se">\</span>
    cert-manager jetstack/cert-manager <span class="se">\</span>
    <span class="nt">--namespace</span> cert-manager <span class="se">\</span>
    <span class="nt">--create-namespace</span> <span class="se">\</span>
    <span class="nt">--version</span> v1.15.3 <span class="se">\</span>
    <span class="nt">--set</span> crds.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nt">--set</span> <span class="nv">enableCertificateOwnerRef</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<p><strong><em>NOTE:</em></strong> The command bove is enabling enableCertificateOwnerRef to allow Cert-manager to delete secrets once Ingress rule is removed.</p>

<p>Let’s Encrypt supports Staging and Production environment, staging is used for testing environments and these certificates are not valid.</p>

<p>Create a ClusterIssuer resource to setup Cert-manager to issue certificates from Let’s Encrypt using staging environment:</p>

<p><strong><em>NOTE:</em></strong> Let’s Encrypt use ACME protocol to issue the certificate and prove domain ownership. It supports DNS01 or HTTP01 protocols. The example bellow is for HTTP01. For DNS01 using Azure DNS please review official <a href="https://cert-manager.io/docs/configuration/acme/dns01/azuredns/">AzureDNS Cert-manager</a> documentation.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cert-manager.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-staging</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">acme</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://acme-staging-v02.api.letsencrypt.org/directory</span>
    <span class="na">email</span><span class="pi">:</span> <span class="s">&lt;email&gt;@&lt;domain&gt;&lt;.com&gt;</span>
    <span class="na">privateKeySecretRef</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-staging</span>
    <span class="na">solvers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http01</span><span class="pi">:</span>
        <span class="na">ingress</span><span class="pi">:</span>
          <span class="na">class</span><span class="pi">:</span> <span class="s">nginx</span>
          <span class="na">podTemplate</span><span class="pi">:</span>
            <span class="na">spec</span><span class="pi">:</span>
              <span class="na">nodeSelector</span><span class="pi">:</span>
                <span class="s2">"</span><span class="s">kubernetes.io/os"</span><span class="err">:</span> <span class="s">linux</span>
</code></pre></div></div>

<p>Create a ClusterIssuer resource to setup Cert-manager to issue certificates from Let’s Encrypt using production environment:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cert-manager.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">acme</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://acme-v02.api.letsencrypt.org/directory</span>
    <span class="na">email</span><span class="pi">:</span> <span class="s">&lt;email&gt;@&lt;domain&gt;&lt;.com&gt;</span>
    <span class="na">privateKeySecretRef</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
    <span class="na">solvers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http01</span><span class="pi">:</span>
        <span class="na">ingress</span><span class="pi">:</span>
          <span class="na">class</span><span class="pi">:</span> <span class="s">nginx</span>
          <span class="na">podTemplate</span><span class="pi">:</span>
            <span class="na">spec</span><span class="pi">:</span>
              <span class="na">nodeSelector</span><span class="pi">:</span>
                <span class="s2">"</span><span class="s">kubernetes.io/os"</span><span class="err">:</span> <span class="s">linux</span>
</code></pre></div></div>

<p>Once the Cert-manager is configured you can create a Ingress rule in your cluster with a special annotation pointing to the ClusterIssuer you would like to use and Cert-manager will automaticaly issue a Let’s Encrypt certificate for you.</p>

<p>Here is a sample application using Ingress rule with cert-manager.io/cluster-issuer annotation to issue a certificate from staging in Let’s Encrypt. The yaml definition is creating a namespace called vws and a deployment, service and ingress using the special annotation from Cert-manager.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vws</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vws-app</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">vws</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">vws-app</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">vws-app</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">vwsapp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">welasco/nodejsportexhaustion</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">256Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">100m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">512Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3000</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vws-service</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">vws</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">3000</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">vws-app</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vws-ingress-testcertmanager</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">vws</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">cert-manager.io/cluster-issuer</span><span class="pi">:</span> <span class="s">letsencrypt-staging</span>
    <span class="c1">#cert-manager.io/cluster-issuer: letsencrypt-prod</span>
    <span class="na">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
    <span class="na">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">tls</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">www.vwslab.com</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">vws-secret</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">www.vwslab.com</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">vws-service</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">3000</span>
</code></pre></div></div>

<p>After apply the yaml manifest a new TLS secret with Let’s Encrypt certificate will be created in the namespace. The secret name will be the name you have defined as your secretName in Ingress rule:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get secrets <span class="nt">-n</span> vws vws-secret

NAME         TYPE                DATA   AGE
vws-secret   kubernetes.io/tls   2      45h
</code></pre></div></div>

<p>Reference:</p>

<p><a href="https://cert-manager.io/docs/installation/helm/">Installing Cert-manager with helm</a></p>

<p><a href="https://cert-manager.io/docs/tutorials/getting-started-aks-letsencrypt/">Deploy cert-manager on Azure Kubernetes Service (AKS) and use Let’s Encrypt to sign a certificate for an HTTPS website</a></p>

<h2 id="2-configure-azure-key-vault">2. <strong>Configure Azure Key Vault</strong></h2>

<p>All the steps will be done using Azure Cli but they can also be accomplished using Azure Portal.</p>

<p>Create a new Azure Key Vault if you don’t have one already:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">AKS</span><span class="o">=</span><span class="s2">"&lt;AKS Name&gt;"</span>
<span class="nv">KEYVAULT_NAME</span><span class="o">=</span><span class="s2">"&lt;Key Vault Name goes here&gt;"</span>
<span class="nv">RG</span><span class="o">=</span><span class="s2">"&lt;Resource Group Name&gt;"</span>
<span class="nv">Location</span><span class="o">=</span><span class="s2">"&lt;Location&gt;"</span>
az keyvault create <span class="sb">`</span>
    <span class="nt">--name</span> <span class="nv">$KEYVAULT_NAME</span> <span class="sb">`</span>
    <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="sb">`</span>
    <span class="nt">--location</span> <span class="nv">$Location</span> <span class="sb">`</span>
    <span class="nt">--enable-rbac-authorization</span>
</code></pre></div></div>

<p>Choose your preferable authentication method to allow SyncSecretAKV controller to access Azure Key Vault.</p>

<p>Using Workload Identity or Managed Identity to access Azure Key Vault</p>

<p>If you are going to use Workload Identity or Managed Identity in Azure, you have to create a Managed Identity Credential.</p>

<p><strong><em>NOTE:</em></strong> Workload Identity requires additional settings to be configured in AKS cluster. Please check <a href="https://learn.microsoft.com/en-us/azure/aks/workload-identity-deploy-cluster">Deploy and configure workload identity on an Azure Kubernetes Service (AKS) cluster</a></p>

<p>The command bellow will create a Managed Identity to be used by SyncSecretAKV controller to access Azure Key Vault:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">USER_ASSIGNED_IDENTITY_NAME</span><span class="o">=</span><span class="s2">"&lt;Managed Identity Name&gt;"</span>
<span class="nv">KEYVAULT_NAME</span><span class="o">=</span><span class="s2">"&lt;Key Vault Name goes here&gt;"</span>
<span class="nv">RG</span><span class="o">=</span><span class="s2">"&lt;Resource Group Name&gt;"</span>
<span class="nv">Location</span><span class="o">=</span><span class="s2">"&lt;Location&gt;"</span>
<span class="nv">Subscription</span><span class="o">=</span><span class="s2">"&lt;Subscription ID&gt;"</span>
az identity create <span class="sb">`</span>
    <span class="nt">--name</span> <span class="nv">$USER_ASSIGNED_IDENTITY_NAME</span> <span class="sb">`</span>
    <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="sb">`</span>
    <span class="nt">--location</span> <span class="nv">$Location</span> <span class="sb">`</span>
    <span class="nt">--subscription</span> <span class="nv">$Subscription</span>
</code></pre></div></div>

<p>Create a Role assigment to allow the Managed Identity to manage certificates in the Azure Key Vault:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KEYVAULT_RESOURCE_ID</span><span class="o">=(</span>az keyvault show <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="nt">--name</span> <span class="nv">$KEYVAULT_NAME</span> <span class="nt">--query</span> <span class="nb">id</span> <span class="nt">--output</span> tsv<span class="o">)</span>
<span class="nv">IDENTITY_PRINCIPAL_ID</span><span class="o">=(</span>az identity show <span class="nt">--name</span> <span class="nv">$USER_ASSIGNED_IDENTITY_NAME</span> <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="nt">--query</span> principalId <span class="nt">--output</span> tsv<span class="o">)</span>
az role assignment create <span class="sb">`</span>
    <span class="nt">--assignee-object-id</span> <span class="nv">$IDENTITY_PRINCIPAL_ID</span> <span class="sb">`</span>
    <span class="nt">--role</span> <span class="s2">"Key Vault Certificates Officer"</span> <span class="sb">`</span>
    <span class="nt">--scope</span> <span class="nv">$KEYVAULT_RESOURCE_ID</span> <span class="sb">`</span>
    <span class="nt">--assignee-principal-type</span> ServicePrincipal
</code></pre></div></div>

<p>Optionally but recommended, you should assign the same priviledge to your personal account:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az role assignment create <span class="sb">`</span>
    <span class="nt">--assignee</span> <span class="s2">"&lt;Your Account Here Ex: user@domain.com&gt;"</span> <span class="sb">`</span>
    <span class="nt">--role</span> <span class="s2">"Key Vault Certificates Officer"</span> <span class="sb">`</span>
    <span class="nt">--scope</span> <span class="nv">$KEYVAULT_RESOURCE_ID</span> <span class="sb">`</span>
    <span class="nt">--assignee-principal-type</span> User
</code></pre></div></div>

<p>Using Service Principal to access Azure Key Vault</p>

<p>If running SyncSecretAKV controller in a On-Premises cluster or ARC enabled Kubernestes cluster you must use Service Principal for authentication.</p>

<p>You can create a new Service Principal using the following command:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ServicePrincipalName</span><span class="o">=</span><span class="s2">"&lt;Service Principal Name Here Ex: SyncSecretAKV-SP&gt;"</span>
az ad sp create-for-rbac <span class="nt">--name</span> <span class="nv">$ServicePrincipalName</span>
</code></pre></div></div>

<p>The create Service Principal command you give you an output, save it because it will be necessary to configure SyncSecretAKV controller:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"appId"</span>: <span class="s2">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span>,
  <span class="s2">"displayName"</span>: <span class="s2">"app-yak"</span>,
  <span class="s2">"password"</span>: <span class="s2">"*************************************"</span>,
  <span class="s2">"tenant"</span>: <span class="s2">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Create a Role assigment to allow the Service Principal to manage certificates in the Azure Key Vault:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KEYVAULT_RESOURCE_ID</span><span class="o">=(</span>az keyvault show <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="nt">--name</span> <span class="nv">$KEYVAULT_NAME</span> <span class="nt">--query</span> <span class="nb">id</span> <span class="nt">--output</span> tsv<span class="o">)</span>
az role assignment create <span class="sb">`</span>
    <span class="nt">--assignee-object-id</span> <span class="s2">"&lt;appId from the previous command&gt;"</span> <span class="sb">`</span>
    <span class="nt">--role</span> <span class="s2">"Key Vault Certificates Officer"</span> <span class="sb">`</span>
    <span class="nt">--scope</span> <span class="nv">$KEYVAULT_RESOURCE_ID</span> <span class="sb">`</span>
    <span class="nt">--assignee-principal-type</span> ServicePrincipal
</code></pre></div></div>

<p>Optionally but recommended, you should assign the same priviledge to your personal account:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az role assignment create <span class="sb">`</span>
    <span class="nt">--assignee</span> <span class="s2">"&lt;Your Account Here Ex: user@domain.com&gt;"</span> <span class="sb">`</span>
    <span class="nt">--role</span> <span class="s2">"Key Vault Certificates Officer"</span> <span class="sb">`</span>
    <span class="nt">--scope</span> <span class="nv">$KEYVAULT_RESOURCE_ID</span> <span class="sb">`</span>
    <span class="nt">--assignee-principal-type</span> User
</code></pre></div></div>

<h2 id="3-deploy-the-controller">3. <strong>Deploy the Controller</strong></h2>

<p>Deploy SyncSecretAKV controller using the commands bellow:</p>

<p>Add a helm repo to your local helm repositories:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add syncsecretakv https://welasco.github.io/syncsecretakv
</code></pre></div></div>

<p>Installing SyncSecretAKV controller for Workload Identity</p>

<p>Install SyncSecretAKV controller for Workload Identity authentication to Azure Key Vault.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">IDENTITY_PRINCIPAL_ID</span><span class="o">=(</span>az identity show <span class="nt">--name</span> <span class="nv">$USER_ASSIGNED_IDENTITY_NAME</span> <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="nt">--query</span> principalId <span class="nt">--output</span> tsv<span class="o">)</span>
helm <span class="nb">install </span>syncsecretakv syncsecretakv/syncsecretakv <span class="se">\</span>
    <span class="nt">--set</span> <span class="nv">namespace</span><span class="o">=</span>syncsecretakv <span class="se">\</span>
    <span class="nt">--set</span> workloadIdentity.userAssignedClientId<span class="o">=</span><span class="nv">$IDENTITY_PRINCIPAL_ID</span>
</code></pre></div></div>

<p>Installing SyncSecretAKV controller for Managed Identity or Service Principal</p>

<p>Install SyncSecretAKV controller for Managed Identity or Service Principal authentication:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>syncsecretakv syncsecretakv
</code></pre></div></div>

<p>After the deployment a new namespace and a few resources will be created. To check if everything looks good run the following command:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get <span class="nt">-n</span> syncsecretakv-system Deployment,ServiceAccount,Service

NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/syncsecretakv-controller-manager   1/1     1            1           21h

NAME                                              SECRETS   AGE
serviceaccount/default                            0         21h
serviceaccount/syncsecretakv-controller-manager   0         21h

NAME                                                       TYPE        CLUSTER-IP        EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
service/syncsecretakv-controller-manager-metrics-service   ClusterIP   xxx.xxx.xxx.xxx   &lt;none&gt;        8443/TCP   21h
</code></pre></div></div>

<h2 id="4-configuring-syncsecretakv-controller">4. <strong>Configuring SyncSecretAKV controller</strong></h2>

<p>SyncSecretAKV controller can be configure to use Workload Identity, Managed Identity or Service Principal to access Azure Key Vault.</p>

<p>It supports Cluster wide configuration or Namespace configuration.</p>

<h3 id="workload-identity">Workload Identity</h3>

<p>To setup SyncSecretAKV controller to use Workload Identity you must install the controller using an additional option with userAssignedClientId to allow the creation of the controller pod with the required tags and annotaions for Workload Identity. Please refer to the step “Install SyncSecretAKV controller for Workload Identity authentication to Azure Key Vault.”</p>

<p>When using Workload Identity the SyncSecretAKV controller only supports one single Federated Managed Identity to access Azure Key Vault. If you require more than one Azure Key Vault (for instance one Azure Key Vault per namespace) you can only use the managed identity defined during the instalation of the controller to allow access in all Azure Key Vaults.</p>

<p>If you have not yet enable AKS to support Workload Identity you can do it using the following command:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az aks update <span class="se">\</span>
    <span class="nt">--name</span> <span class="nv">$AKS</span> <span class="se">\</span>
    <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="se">\</span>
    <span class="nt">--enable-oidc-issuer</span> <span class="se">\</span>
    <span class="nt">--enable-workload-identity</span>
</code></pre></div></div>

<p>Now associate a federated identity with the managed identity that you created earlier. SyncSecretAKV controller will authenticate to Azure using a short lived Kubernetes ServiceAccount token, and it will be able to impersonate the managed identity that you created in the previous step.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">SERVICE_ACCOUNT_NAME</span><span class="o">=</span>syncsecretakv-controller-manager <span class="c"># This is the default Kubernetes ServiceAccount used by the SyncSecretAKV controller.</span>
<span class="nb">export </span><span class="nv">SERVICE_ACCOUNT_NAMESPACE</span><span class="o">=</span>syncsecretakv-system <span class="c"># This is the default namespace for SyncSecretAKV.</span>
<span class="nb">export </span><span class="nv">SERVICE_ACCOUNT_ISSUER</span><span class="o">=</span><span class="si">$(</span>az aks show <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="nt">--name</span> <span class="nv">$AKS</span> <span class="nt">--query</span> <span class="s2">"oidcIssuerProfile.issuerUrl"</span> <span class="nt">-o</span> tsv<span class="si">)</span>
az identity federated-credential create <span class="se">\</span>
  <span class="nt">--name</span> <span class="s2">"cert-manager"</span> <span class="se">\</span>
  <span class="nt">--identity-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">USER_ASSIGNED_IDENTITY_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--issuer</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SERVICE_ACCOUNT_ISSUER</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--subject</span> <span class="s2">"system:serviceaccount:</span><span class="k">${</span><span class="nv">SERVICE_ACCOUNT_NAMESPACE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">SERVICE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>To setup SyncSecretAKV controller using Workload Identity for the entire cluster create a ClusterConfig resource with your desired configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">api.syncsecretakv.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">syncsecretakv</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">kustomize</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clusterconfig-sample</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">azKeyVaultURL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://&lt;Azure</span><span class="nv"> </span><span class="s">Key</span><span class="nv"> </span><span class="s">Vault</span><span class="nv"> </span><span class="s">name&gt;.vault.azure.net/"</span>
  <span class="na">allowAzKeyVaultCertificateDeletion</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">filterMatchingNamespace</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">vws"</span>
  <span class="c1"># filterMatchingLabels:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
  <span class="na">filterMatchingAnnotations</span><span class="pi">:</span>
    <span class="na">cert-manager.io/issuer-group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cert-manager.io"</span>
  <span class="c1">#   label2: "label2"</span>
</code></pre></div></div>

<p>To setup SyncSecretAKV controller using Workload Identity for a specific namespace create a Config resource with your desired configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">api.syncsecretakv.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">syncsecretakv</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">kustomize</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">config-sample</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">vws</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">azKeyVaultURL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://&lt;Azure</span><span class="nv"> </span><span class="s">Key</span><span class="nv"> </span><span class="s">Vault</span><span class="nv"> </span><span class="s">name&gt;.vault.azure.net/"</span>
  <span class="na">allowAzKeyVaultCertificateDeletion</span><span class="pi">:</span> <span class="no">true</span>
  <span class="c1"># filterMatchingLabels:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
  <span class="c1"># filterMatchingAnnotations:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
</code></pre></div></div>

<h3 id="managed-identity">Managed Identity</h3>

<p>To use Managed Identity you have to associate the Managed Identity with all NodePools (VMSS) of AKS Cluster.</p>

<p>You can use the script bellow to associate your Managed Identity to all VMSS (nodepools) of your cluster:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">managedIdentityResourceId</span><span class="o">=</span><span class="si">$(</span>az identity show <span class="nt">--name</span> <span class="nv">$USER_ASSIGNED_IDENTITY_NAME</span> <span class="nt">--resource-group</span> <span class="nv">$RG</span> <span class="nt">--query</span> <span class="nb">id</span> <span class="nt">--output</span> tsv<span class="si">)</span>
<span class="nv">nodeResourceGroup</span><span class="o">=</span><span class="si">$(</span>az aks show <span class="nt">-g</span> eslz-spoke <span class="nt">--name</span> eslz-aks <span class="nt">--query</span> nodeResourceGroup <span class="nt">-o</span> tsv<span class="si">)</span>
<span class="nv">nodepools</span><span class="o">=</span><span class="si">$(</span>az aks nodepool list <span class="nt">-g</span> eslz-spoke <span class="nt">--cluster-name</span> eslz-aks <span class="nt">--query</span> <span class="s2">"[].name"</span> <span class="nt">--output</span> tsv<span class="si">)</span>
<span class="nv">vmssList</span><span class="o">=</span><span class="si">$(</span>az vmss list <span class="nt">-g</span> <span class="nv">$nodeResourceGroup</span> <span class="nt">--query</span> <span class="s2">"[].name"</span> <span class="nt">--output</span> tsv<span class="si">)</span>

<span class="k">for </span>vmss <span class="k">in</span> <span class="nv">$vmssList</span>
<span class="k">do
    </span><span class="nb">echo</span> <span class="nv">$vmss</span>
    az vmss identity assign <span class="nt">-g</span> <span class="nv">$nodeResourceGroup</span> <span class="nt">-n</span> vmss <span class="nt">--identities</span> <span class="nv">$managedIdentityResourceId</span>
<span class="k">done</span>
</code></pre></div></div>

<p>You can repeat the previous step for all your managed identities in case you are giving one identity per Azure Key Vault.</p>

<p>To setup SyncSecretAKV controller using Managed Identity for the entire cluster create a ClusterConfig resource with your desired configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">api.syncsecretakv.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">syncsecretakv</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">kustomize</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clusterconfig-sample</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">azKeyVaultURL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://&lt;Azure</span><span class="nv"> </span><span class="s">Key</span><span class="nv"> </span><span class="s">Vault</span><span class="nv"> </span><span class="s">name&gt;.vault.azure.net/"</span>
  <span class="na">azKeyvaultClientId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Managed</span><span class="nv"> </span><span class="s">Identity</span><span class="nv"> </span><span class="s">Client</span><span class="nv"> </span><span class="s">ID/appId&gt;"</span>
  <span class="na">allowAzKeyVaultCertificateDeletion</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">filterMatchingNamespace</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">vws"</span>
  <span class="c1"># filterMatchingLabels:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
  <span class="na">filterMatchingAnnotations</span><span class="pi">:</span>
    <span class="na">cert-manager.io/issuer-group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cert-manager.io"</span>
  <span class="c1">#   label2: "label2"</span>
</code></pre></div></div>

<p>To setup SyncSecretAKV controller using Managed Identity for a specific namespace create a Config per namespace with your desired configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">api.syncsecretakv.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">syncsecretakv</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">kustomize</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">config-sample</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">vws</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">azKeyVaultURL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://&lt;Azure</span><span class="nv"> </span><span class="s">Key</span><span class="nv"> </span><span class="s">Vault</span><span class="nv"> </span><span class="s">name&gt;.vault.azure.net/"</span>
  <span class="na">allowAzKeyVaultCertificateDeletion</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">azKeyvaultClientId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Managed</span><span class="nv"> </span><span class="s">Identity</span><span class="nv"> </span><span class="s">Client</span><span class="nv"> </span><span class="s">ID/appId&gt;"</span>
  <span class="c1"># filterMatchingLabels:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
  <span class="c1"># filterMatchingAnnotations:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
</code></pre></div></div>

<h3 id="service-principal">Service Principal</h3>

<p>To use the Service Principal you will need the output after you have created it.</p>

<p>To setup SyncSecretAKV controller using Service Principal for the entire cluster create a ClusterConfig resource with your desired configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">api.syncsecretakv.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">syncsecretakv</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">kustomize</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clusterconfig-sample</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">azKeyVaultURL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://&lt;Azure</span><span class="nv"> </span><span class="s">Key</span><span class="nv"> </span><span class="s">Vault</span><span class="nv"> </span><span class="s">name&gt;.vault.azure.net/"</span>
  <span class="na">azKeyvaultClientId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Service</span><span class="nv"> </span><span class="s">Principal</span><span class="nv"> </span><span class="s">appId&gt;"</span>
  <span class="na">azKeyVaultClientSecret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Service</span><span class="nv"> </span><span class="s">Principal</span><span class="nv"> </span><span class="s">Secret&gt;"</span>
  <span class="na">azKeyVaultTenantId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Microsoft</span><span class="nv"> </span><span class="s">Entra</span><span class="nv"> </span><span class="s">tenant</span><span class="nv"> </span><span class="s">Id&gt;"</span>
  <span class="na">allowAzKeyVaultCertificateDeletion</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">filterMatchingNamespace</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">vws"</span>
  <span class="c1"># filterMatchingLabels:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
  <span class="na">filterMatchingAnnotations</span><span class="pi">:</span>
    <span class="na">cert-manager.io/issuer-group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cert-manager.io"</span>
  <span class="c1">#   label2: "label2"</span>
</code></pre></div></div>

<p>To setup SyncSecretAKV controller using Service Principal for a specific namespace create a Config per namespace with your desired configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">api.syncsecretakv.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">syncsecretakv</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">kustomize</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">config-sample</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">vws</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">azKeyVaultURL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://&lt;Azure</span><span class="nv"> </span><span class="s">Key</span><span class="nv"> </span><span class="s">Vault</span><span class="nv"> </span><span class="s">name&gt;.vault.azure.net/"</span>
  <span class="na">allowAzKeyVaultCertificateDeletion</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">azKeyvaultClientId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Service</span><span class="nv"> </span><span class="s">Principal</span><span class="nv"> </span><span class="s">appId&gt;"</span>
  <span class="na">azKeyVaultClientSecret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Service</span><span class="nv"> </span><span class="s">Principal</span><span class="nv"> </span><span class="s">Secret&gt;"</span>
  <span class="na">azKeyVaultTenantId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;Microsoft</span><span class="nv"> </span><span class="s">Entra</span><span class="nv"> </span><span class="s">tenant</span><span class="nv"> </span><span class="s">Id&gt;"</span>
  <span class="c1"># filterMatchingLabels:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
  <span class="c1"># filterMatchingAnnotations:</span>
  <span class="c1">#   label1: "label1"</span>
  <span class="c1">#   label2: "label2"</span>
</code></pre></div></div>

<p>Oberve that you can filter the controller to watch for specifics screts based in the namespace, labels or annotations by modifing the relative entries filterMatchingNamespace, filterMatchingLabels and filterMatchingAnnotations.</p>

<p>It also allows you to auto delete and purge certificates from Azure Key Vault, by changing allowAzKeyVaultCertificateDeletion to true or false.</p>

<p>Now for all TLS Secrets created by Cert-manager will be synchrnized to Azure Key Vault allowing you to re-use the Let’s Encrypt certificate anywhere in Azure.</p>


      </section>
      <footer>
        
          <p>Project maintained by <a href="https://github.com/Welasco">Welasco</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/mattgraham">mattgraham</a></small></p>
      </footer>
    </div>
  </body>
</html>
